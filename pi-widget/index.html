<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi区块数据展示 - 极客商城</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            width: 100%;
            overflow: hidden !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .single-page-container {
            width: 96vw;
            height: 96vh;
            max-width: 1200px;
            max-height: 780px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 2px solid #333;
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }
        .header-left {
            display: flex;
            align-items: center;
        }
        .pi-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 22px;
            margin-right: 15px;
        }
        .header-text h1 {
            font-size: 1.5rem;
            color: #1a1a1a;
            margin-bottom: 4px;
        }
        .header-text p {
            font-size: 0.85rem;
            color: #666;
        }
        
        .refresh-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .refresh-btn.refreshing i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .data-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }
        @media (max-width: 768px) {
            .metrics-grid { 
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }
        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px 15px;
            text-align: center;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .metric-icon {
            font-size: 24px;
            color: #4f46e5;
            margin-bottom: 12px;
        }
        .metric-value {
            font-size: 1.9rem;
            font-weight: 800;
            color: #000;
            margin-bottom: 6px;
            font-family: 'Courier New', monospace;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .metric-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
        }
        
        .blocks-section {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .section-title {
            font-size: 1.1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .block-list {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
            overflow: hidden;
        }
        .block-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        .block-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .block-row:last-child { margin-bottom: 0; }
        .block-label {
            font-weight: 500;
            color: #666;
        }
        .block-value {
            font-weight: 600;
            color: #000;
        }
        .block-height {
            color: #4f46e5 !important;
        }
        
        .legal-footer {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            border-radius: 8px;
            padding: 14px;
            margin-top: 20px;
            text-align: center;
        }
        .legal-text {
            font-size: 0.78rem;
            color: #856404;
            line-height: 1.4;
        }
        
        .status-indicator {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .status-green { background: #10b981; }
        .status-red { background: #ef4444; }
        .status-yellow { background: #f59e0b; }
        
        .loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes loading {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="single-page-container">
        <!-- 头部 -->
        <div class="page-header">
            <div class="header-left">
                <div class="pi-logo">π</div>
                <div class="header-text">
                    <h1>Pi区块数据</h1>
                    <p>极客商城 • 实时同步</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="status-indicator" id="apiStatus">
                    <span class="status-dot status-yellow"></span>
                    <span>连接中...</span>
                </div>
                <button class="refresh-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                    刷新
                </button>
            </div>
        </div>
        
        <!-- 数据区域 -->
        <div class="data-content">
            <!-- 核心指标 -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-cube"></i></div>
                    <div class="metric-value" id="blockHeight">
                        <div class="loading" style="height: 38px; width: 120px; margin: 0 auto;"></div>
                    </div>
                    <div class="metric-label">区块高度</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-exchange-alt"></i></div>
                    <div class="metric-value" id="totalTransactions">
                        <div class="loading" style="height: 38px; width: 120px; margin: 0 auto;"></div>
                    </div>
                    <div class="metric-label">总交易数</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-users"></i></div>
                    <div class="metric-value" id="totalAccounts">
                        <div class="loading" style="height: 38px; width: 120px; margin: 0 auto;"></div>
                    </div>
                    <div class="metric-label">账户总数</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-network-wired"></i></div>
                    <div class="metric-value" id="networkStatus">
                        <div class="loading" style="height: 38px; width: 120px; margin: 0 auto;"></div>
                    </div>
                    <div class="metric-label">网络状态</div>
                </div>
            </div>
            
            <!-- 区块列表 -->
            <div class="blocks-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-list-ul"></i> 最新区块
                    </div>
                    <div class="status-indicator">
                        <span>最后更新: </span>
                        <span id="lastUpdate">--:--</span>
                    </div>
                </div>
                <div class="block-list" id="blockList">
                    <!-- 数据加载中 -->
                </div>
            </div>
        </div>
        
        <!-- 法律声明 (这是你强调要保留的部分) -->
        <div class="legal-footer">
            <div class="legal-text">
                <strong>声明：数据实时同步自Pi Network区块链，
                <strong>仅做技术展示，不构成任何投资建议</strong>。
            </div>
        </div>
    </div>

    <script>
        // ==================== 【唯一修改的部分】使用你的GitHub代理 ====================
        const PROXY_BASE_URL = 'https://zuozi883.github.io/pi-network-proxy';
        // ==================== 修改结束 ====================

        let isConnected = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面初始化，使用稳定代理...');
            updateStatus('yellow', '连接中...');
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                this.classList.add('refreshing');
                updateStatus('yellow', '刷新中...');
                loadData();
                setTimeout(() => this.classList.remove('refreshing'), 1000);
            });
            
            loadData();
            setInterval(() => {
                if (isConnected) {
                    loadData();
                }
            }, 120000);
        });
        
        async function loadData() {
            try {
                console.log('通过稳定代理加载数据...');
                
                // 使用你的GitHub Pages代理
                const [statsResponse, blocksResponse] = await Promise.all([
                    fetch(`${PROXY_BASE_URL}/proxy.js?endpoint=/network/stats&_t=${Date.now()}`),
                    fetch(`${PROXY_BASE_URL}/proxy.js?endpoint=/blocks&order=desc&limit=4&_t=${Date.now()}`)
                ]);
                
                const statsResult = await statsResponse.json();
                const blocksResult = await blocksResponse.json();
                
                if (!statsResult.success || !blocksResult.success) {
                    throw new Error('代理返回数据失败');
                }
                
                updateStats(statsResult.data);
                updateBlocks(blocksResult.data);
                updateTime();
                
                isConnected = true;
                updateStatus('green', '已同步');
                
            } catch (error) {
                console.error('数据加载失败:', error);
                isConnected = false;
                updateStatus('red', '同步失败');
                showError();
            }
        }
        
        // ==================== 以下所有函数保持原样，完全未修改 ====================
        function updateStats(data) {
            const blockHeight = data.ledger?.sequence || 0;
            const totalTx = data.transactions || 0;
            const totalAccounts = data.accounts || 0;
            
            document.getElementById('blockHeight').innerHTML = formatNumber(blockHeight);
            document.getElementById('totalTransactions').innerHTML = formatNumber(totalTx);
            document.getElementById('totalAccounts').innerHTML = formatNumber(totalAccounts);
            document.getElementById('networkStatus').innerHTML = `<span style="color:#10b981;">正常</span>`;
        }
        
        function updateBlocks(data) {
            const container = document.getElementById('blockList');
            const blocks = data._embedded?.records || [];
            
            if (blocks.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align:center; padding:40px; color:#666;">
                        <div>暂无区块数据</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            blocks.forEach(block => {
                const div = document.createElement('div');
                div.className = 'block-item';
                
                const timeAgo = getTimeAgo(block.closed_at);
                
                div.innerHTML = `
                    <div class="block-row">
                        <span class="block-label">区块高度</span>
                        <span class="block-value block-height">#${formatNumber(block.sequence)}</span>
                    </div>
                    <div class="block-row">
                        <span class="block-label">时间</span>
                        <span class="block-value">${timeAgo}</span>
                    </div>
                    <div class="block-row">
                        <span class="block-label">交易数</span>
                        <span class="block-value">${block.transaction_count || 0} 笔</span>
                    </div>
                    <div class="block-row">
                        <span class="block-label">哈希</span>
                        <span class="block-value" style="font-family:monospace; font-size:0.85em;">
                            ${(block.hash || '').substring(0, 10)}...
                        </span>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }
        
        function updateStatus(color, text) {
            const element = document.getElementById('apiStatus');
            const dot = element.querySelector('.status-dot');
            
            dot.className = 'status-dot';
            if (color === 'green') dot.classList.add('status-green');
            else if (color === 'red') dot.classList.add('status-red');
            else dot.classList.add('status-yellow');
            
            element.querySelector('span:last-child').textContent = text;
        }
        
        function updateTime() {
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('lastUpdate').textContent = timeStr;
        }
        
        function getTimeAgo(timestamp) {
            if (!timestamp) return '未知';
            
            const past = new Date(timestamp);
            const now = new Date();
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return '刚刚';
            if (diffMins < 60) return `${diffMins}分钟前`;
            return `${Math.floor(diffMins/60)}小时前`;
        }
        
        function formatNumber(num) {
            if (typeof num !== 'number') return '0';
            return num.toLocaleString('zh-CN');
        }
        
        function showError() {
            document.getElementById('blockHeight').innerHTML = '--';
            document.getElementById('totalTransactions').innerHTML = '--';
            document.getElementById('totalAccounts').innerHTML = '--';
            document.getElementById('networkStatus').innerHTML = `<span style="color:#ef4444;">离线</span>`;
            
            const container = document.getElementById('blockList');
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align:center; padding:30px; color:#666;">
                    <div style="color:#ef4444; margin-bottom:10px;">
                        <i class="fas fa-exclamation-circle"></i>
                        网络连接异常
                    </div>
                    <button class="refresh-btn" onclick="window.location.reload()" 
                            style="padding:8px 20px; margin-top:10px;">
                        <i class="fas fa-redo"></i> 重新加载
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>